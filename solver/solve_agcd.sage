#!/usr/bin/env sage
# DGHV Approximate GCD Solver
# Run with: sage solve_agcd.sage

ciphertexts = [
    22745078551052576311530329009663877474085945976888214633735490045829081992161571464000763624165823754942666738025168881160445422770661618260213950552290579081253456374595049397048072127523216179124540200319149411765964744781649416310941436584309724843164692147247574955241756802848392470353098008897704887947765306210566508204400504166185147513836,
    7457033716968836090354555928849213483610229606067946970072790145619042688405594524560328450282541575546754392383078117373795937011804343107613125943713232732510893629136653734775170853545981141989828334196972482538074593637055653123163016467155330795028595507334331892076179195705333115298589186937861895551723990773569258490201874271237273700357,
    28606857096401985877488128720437640588389195608999574032911460517649936491235007801780182626499633358628641284955066695996813845176485203817531044521544974843000357800164601438802415142718762668654851591818415978519141895448237881342878689366504773688586334675674035714851063562147687790087289902349231393798726421903862691664409870200512078970294,
    5773345776473192284169361610720202064998974879677588097562503271894189824605096080201904726781136334579409640969340597568973507616939099343264396752268340013533821672482722300781304295057785686893829124242490203028788624425756589310314628067360372972960068333810727149242659594522435507017803631800276197741331801642541137824582129863839392615749,
    1492907591077746364062154629404424488243621032188926616704848776500659159287867774705380607404469182984555852743253570388157153872409993814509608763889549020464088831805179551700818111776078079889205860606695246420603513508066931497422121997903513851267673039610963441174065963915634451865015243780483732891104410756772071601834149484816758976999,
    28399354886889970188253684599905194268404141417593584535450019137981788361580588211495289455109748236840201935611073056281008405430563551432132473037367384782610191773233297691826609026819132060072071278710827202246103761484597847167768478165599129866028870450378267043562596431723666217660807615245109899667478654481285776559726485395103703208014,
    14363139657327206318843247187825767401707760582724336244442787544210938570459446140838772415436509534121670881633006477963978386101463670316191004539686956587654542446182822543838088350738260274436155162924184684909416208265118528291274380941308778201097787715132290741093879084711084835960329738433284095971279714743841922436775586777301452690461,
    15838503812111887868482258671066235487559889914523752797806879065210598919157461359526115785261293817139217298788624597567763970109360697859487373504076774096721436370383982131735875567881344443505209001071293195488483118200706231405222943613113908367892355922874199940697120055165154559436282613357669084374973099752491895774139402736066794031903,
    30613252009143283589043337171253714271355857832874216863548009006772332770589240761971613289688713297586335082436667160526411306248539249616245565802429739972468203025893955815976740341643960902523927471177039700519551210287517268646698758608119066659367517666358196258654409928615446656813347536542634268080733250217870413553471369505731976589302,
    16528023880731549010859332173328175590006552900550719585237909432576379598062538124521121326482411462443081299067254431692047829637581230941765206865074957134380596298098657016580919677045340854282103635286672804822332680430316353114566488203876972477698120914333063589140682479126155155445946839513869428176867169623311689495067365963514560658385,
    16979505631751819395557764097160391533730310273971728689211033587400291484210301312245077469956477137358649481737912466647408229791686249351396278010886260756333744012715938003416986614731364515189977582464563504334527977587338273767207324205656789402919557204395434020192689052869193522578400347167719824786519711085369361205330936568346658881967,
    17717379073388590581795904791531864405720720324409122095836418638301267437463739095544755320563468347569834107936218602025204975200496359782789638526671344148843410182255831213794056006169847464346250278320183052751239708387268882281460488492085072416503336495899906629491007913970544809144366632317019320561500514016440381695374676928562120353394,
    21268741878125925909681767207081024360127152478433998358866670484923729023027654076707215338816199417711991580653419656692323443061962055716134373817443864319996955732831521070350049721906994492933171901481603598430365824928575482103392815541486056128315035561933729588352944171624373021910079833762350741310765376068816583513626745958406919290681,
    30010925034812234979220837825178814109793482500899293027320461635859470788539043433374484685286505399479221566881110295464078573169723444665119802921824430601393323896044345669050913429718303922266756349786382623008325155386173361836661182410937321750599150327259324560203760610665267077297116696697387441709829854711287948290432493678990198728009,
    10597132146614194804481178269038986147095378667033063444799955835434424590313233160462713082773314178987765397576724891952262255067596247327788684446132082788986582915635568929522587791815258819333989312715206982100934511490648625501085373656804295902659051636903206433587340433328447560890145044320569201266618747591637808287460060998875104104916,
    17260775418063565534623711843868719776503449310303177035256208602317073681489959740202081667762446650104256921532928644399738938481282756493999444855284324358233656708510273915377191363176281568401956716001441225439424591602445592899310509614708950330543958702290703965307618197345381174414990304590522931068292626092037576592193811281167752265335,
    28433484474738445089777963738073781049174931326074069599358373359405959429418961589504724342666209743636748618146164331466240733782874633638935021351389007036343150784311196342997373951262408789055005058484548317250194206360932044724542726079254635945584940894720729951234337228417955334237990249588825302543737947505414112719941755131407166830515,
    718871925619319880167979123142059854809085955520917194459411643678062980088499365246967142602064927840384099195219835114127254866606197066009281570798580258910662237498034136325274548795454174393183380994930779080817220329093162191315727767278854676343932155665751410954072134323908399959410826487536703253950239765257866242981730687791002605252,
    10164191331820818366372567528408330859450402361419765285671173126882326351988946647398406491313393173165547371314922621391466467334169287762248287380496635883788353609748058483172570859710053384064343813356135232247281007084885271154508221355065523470565675660707881422417722803432579012274819357083762791066547838626360963460543864654036483804146,
    20364120925166455767458018815107465453827071692969252735138861742567701379155646587363061307013035108134043041756724499085134690551617492289972924061692066826070075417391717668874860057399858297162743690505156077812036354560814965082958655671640414434609446907851866664887140394211835221564995653765097391159588079237609554214175779529683794013272,
    8978148371806797020172988917173813808281068406615288554084512930124039864307395216954397550244390291186621634036742061545617569803973112740387795426287847881049094836501715085476608634311418566942185053901988306063894099512728612724764850962561120802752486109762410413719014899084773693395307673968433293308940745136593906880216916786114760585921,
    30977991657965737079538436490359708874838186828800264541243253380695589378719879393206105214000283365114985899632453576386909772524474444897841634637026577629986688981479938467547755989480208306687582977801584577436304111304024936577721401132208629119478054934364594527472321836104912892027237209061933418062237723764506673765338346851191353791787,
    22130235321259598772973756993919605662271679290992401166031810270316428685693178361015652624560239561548247476451580705613158914788934776201207174145363086168170583215300713651229213839451671019826809463848971192538641937600728987995684437738595596683567262903583956128257771023771580855165106988476956149704013999164299462687265624322677820898258,
    14613357730023930866366734160843999951207782922792586887668797222666224795309880926629919412872455521741863453143931698587366706058396581603701196314520495402644553928207886665962422020232099219832742180482967717745142696710972537085566735807702890250521853915381042409810097345871551507751370558688813437950813784349681430997128755082413714675797,
    25657212018200751282251832966088937502292869539631606254305588670140367850260943392489118366598553202175573233236881067909984569040868183786133732714260449268258440072302393613347221484956698969362591701617996002216301008896826153909561751456559775647136377622038890767756089940277052755335554305479623077135854623109764983212686804256303359462767,
    4316807114364697324385345654809918463289988080594479802570561605992090216983894744459700181788629718190173230828594340916130989178225977616302555609146223817131104474822979320018229430064202451906947770143075763819823171361580538686236043502779132557816190299975308187626170900051973519433697939601998804383276871575882041819554174544374041231000,
    22720030677601738508600998167174804970700153704177940683395422846106707417233225869111342530876705571511384480992793170300179646400413791434482314859409444223138145044567730556818504141841616024666455158506089336533164713451886939878085550386828392445990529349303565760374950792109854357362235540216667661440533802797779049963149405098845311727094,
    27703909334684520294888873185998568975357726141471282942584616556123549654103105710335196247835474727059225442266372216922498307227363463269381148765822542034055982372515071962334851211716034083863510746172802465445459719645824094947614568320534140877286925680908920790973585218174656819099894172926849427738972286631676757308025846653052552597462,
    7568034899728986415494940604747532189187297029396288956177244227197692443868973103545366635550708518357643110065801949912899723298366267332822559947277280317409860322968831991688941469412477377854858789883282735438801709199648844570315265151430758200657388281243996446994815359087038076396822670214093079812943174780172313404018288795961353410256,
    31102925212274460368175449041545234186952959983605444727867565654838040425550385577986451863810677308118706630996284494935011979424215586069403041099595288833168996825381595274797618273045938910161985157828402829864877982990532029110651945777318185967879056612685649727408884068046816578522364795147674332693088459831058789648795162782492662467411,
    9770602540201223610748641106109381076200489484281170898610124648775420320486624939047711952191868829834302687034816249670025884793669817258023349696843225203062456450839829752550282586848075610561852637750799259790895844718239888362921732888988178107405041546616224320899873213837138406223478264165755847953574541890847618645498780713067877959461,
    16061672202076018552407426966152524003392089961544948082300077618854420847739836912864981211192935232573301896511784623532203628270654212512272067187022056576344126497694947105205641169211059087237101516657790475971427548386275084588491378714214297748218987667869256722554730253943021587823215284804876805033035754162665532223094008591926110166113,
    3938949347878264899739103957180488750721756487437292158070733068509174574025524945545540395846150448074465676020287274541117449832460313054016488041467081825732823483567974837066055383874547386412940329819074135515446787614403885097433733321014347362237414706897857566096435854984190452509795021693619011074478097170370134060668801441328535436581,
    12267389864742948780381105602924483353318876436800807659325461795513054058509634169213380736192338121287907454185646611797302172060533043998711329273613613420333307093903815051145676962391670722706235026467303608470560470913456074371554262635480780653405859714650649132873675979036556267185186388394992782153362264883680889629722563003599655021344,
    8316974979949238986520972109323287298216895507515799329987968242197621583275676101117269781723086311103119304698987676389823363667883074300951065522347060199080775071518036393428523560998295597415037204031753703031983146645881253607395412599028188771143315432910563752082556390277204900910977383437091364869347289701156119387836181047560511825393,
    26837129486263216622295447045799630205212753887588203536599518446813754968431118941509430017987510010702100674965105886793073315612295640383622857288045852756470618738701249992139912318858579153083620315957040923937337216848561550119286406734258392722029397755201930102373877372769418055917498802627740548209707701523217193727305170341716967927783,
]

print(f"[*] Loaded {len(ciphertexts)} ciphertexts")

# Parameters
noise_bits = 126
N = 128

# Method 1: Howgrave-Graham's Orthogonal Lattice Attack
def orthogonal_lattice_attack(cts, num=5):
    """
    Create orthogonal lattice from approximate GCD instances
    """
    n = min(num, len(cts))
    c0 = cts[0]
    
    # Scale factor
    K = 2^noise_bits
    
    # Build matrix: first row is scaling, rest encode differences
    M = matrix(ZZ, n, n)
    M[0, 0] = K
    for i in range(1, n):
        M[0, i] = cts[i]  
        M[i, i] = -c0
    
    print(f"[*] Running LLL on {n}x{n} matrix...")
    L = M.LLL()
    
    print("[*] Checking short vectors...")
    for row in L:
        for entry in row:
            if entry != 0:
                g = gcd(c0, abs(entry))
                if g > 1 and 120 <= g.nbits() <= 140:
                    print(f"  Candidate: {g} ({g.nbits()} bits)")
                    if is_prime(g):
                        return g
    
    return None

# Method 2: Use ratios
def ratio_attack(cts):
    """
    Use continued fractions on ratios
    """
    c0, c1 = cts[0], cts[1]
    
    cf = continued_fraction(c0/c1)
    for conv in cf.convergents()[:100]:
        h, k = conv.numerator(), conv.denominator()
        if k == 0:
            continue
        
        diff = c0 * k - c1 * h
        if diff != 0:
            g = gcd(c0, abs(diff))
            if g > 1 and 120 <= g.nbits() <= 140 and is_prime(g):
                print(f"[!] Found p via CF: {g}")
                return g
    
    return None

# Method 3: Multivariate approach
def multivariate_attack(cts, dim=7):
    """
    Use more ciphertexts for a better lattice
    """
    n = min(dim, len(cts))
    c0 = cts[0]
    
    # Construct Coppersmith-style lattice
    K = 2^(noise_bits + 10)  # Slightly larger scale
    
    M = matrix(ZZ, n+1, n+1)
    M[0, 0] = K
    for i in range(n):
        M[i+1, 0] = cts[i]
        M[i+1, i+1] = c0
    
    print(f"[*] Running BKZ on {n+1}x{n+1} matrix...")
    L = M.BKZ(block_size=20)
    
    print("[*] Analyzing reduced basis...")
    candidates = []
    for row in L:
        val = row[0]
        if val != 0 and val.nbits() < 200:
            # This might be related to p
            g = gcd(c0, abs(val))
            if 1 < g.nbits() <= 140:
                candidates.append(g)
    
    return candidates

# Run attacks
print("\n[*] Running ratio attack...")
p = ratio_attack(ciphertexts)

if not p:
    print("\n[*] Running orthogonal lattice attack...")
    p = orthogonal_lattice_attack(ciphertexts, num=6)

if not p:
    print("\n[*] Running multivariate attack...")
    candidates = multivariate_attack(ciphertexts)
    for c in set(candidates):
        if is_prime(c) and 120 <= c.nbits() <= 140:
            p = c
            break

if p:
    print(f"\n[!!!] Found p = {p}")
    print(f"[*] p has {p.nbits()} bits")
    
    # Decrypt flag
    flag = ""
    for c in ciphertexts:
        m = (c % p) % N
        flag += chr(m)
    
    print(f"\n[!!!] FLAG: {flag}")
else:
    print("\n[!] Could not find p")
